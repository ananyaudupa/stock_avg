<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Average & RSI Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  padding: 10px;
  margin: 0;
}
.container {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  max-width: 800px;
  margin: auto;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h2 { text-align: center; color: #333; margin-bottom: 20px; }
.row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin: 10px 0;
}
input {
  flex: 1;
  min-width: 160px;
  max-width: 250px;
  padding: 12px;
  margin: 5px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
}
button {
  padding: 14px 20px;
  margin: 10px 5px;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: white;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s;
}
button:hover { background: #0056b3; }
.result {
  margin-top: 20px;
  padding: 18px;
  border-radius: 10px;
  background: #f9f9f9;
  text-align: left;
  font-size: 16px;
}
.profit { color: green; font-weight: bold; }
.loss { color: red; font-weight: bold; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  table-layout: fixed;
}
th, td {
  padding: 10px;
  text-align: center;
  font-size: 15px;
  border: 1px solid #ccc;
  word-wrap: break-word;
}
th { background-color: #f1f1f1; }

/* Responsive */
@media (max-width: 600px) {
  input { flex: 100%; max-width: 100%; font-size: 14px; padding: 10px; }
  button { width: 100%; font-size: 14px; padding: 12px; }
  .row { flex-direction: column; align-items: center; }
  table, th, td { font-size: 13px; padding: 8px; }
}
</style>
</head>
<body>
<div class="container">
  <h2>üìä Stock Average & RSI Calculator</h2>

  <div class="row">
    <input type="text" id="stockName" placeholder="Stock Symbol (e.g. AAPL, RELIANCE.NS)" oninput="this.value = this.value.toUpperCase()">
  </div>

  <div id="buys"></div>
  <button onclick="addBuy()">‚ûï Add Buy</button>

  <div class="row">
    <input type="number" id="currentPrice" placeholder="Current Price">
  </div>
  <button onclick="calculate()">Calculate</button>

  <div class="result" id="result"></div>
  <div class="result" id="rsiResult"></div>

  <h3>üíæ Saved Entries</h3>
  <button onclick="clearHistory()" style="background:red;">Clear All History</button>
  <table id="historyTable">
    <thead>
      <tr>
        <th>Stock</th>
        <th>Avg Price</th>
        <th>Total Investment</th>
        <th>Current Price</th>
        <th>Profit/Loss</th>
        <th>RSI (14)</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<script>
let buyCount = 0;

// Add new buy row
function addBuy() {
  buyCount++;
  const div = document.createElement('div');
  div.className = "row";
  div.innerHTML = `
    Buy ${buyCount}: 
    <input type="number" class="price" placeholder="Price"> 
    <input type="number" class="qty" placeholder="Quantity">`;
  document.getElementById("buys").appendChild(div);
}

// Load saved history
function loadHistory() {
  const history = JSON.parse(localStorage.getItem("stockHistory") || "[]");
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";
  history.forEach((entry, index) => {
    const row = `<tr>
      <td>${entry.stock}</td>
      <td>${entry.avgPrice}</td>
      <td>${entry.totalInvestment}</td>
      <td>${entry.currentPrice}</td>
      <td style="color:${entry.profitLoss>=0?'green':'red'}">${entry.profitLoss}</td>
      <td>${entry.rsi}</td>
      <td><button onclick="deleteEntry(${index})" style="background:red; padding:5px 8px;">Delete</button></td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

// Delete single entry
function deleteEntry(index) {
  const history = JSON.parse(localStorage.getItem("stockHistory") || "[]");
  history.splice(index, 1);
  localStorage.setItem("stockHistory", JSON.stringify(history));
  loadHistory();
}

// Clear all history
function clearHistory() {
  if(confirm("Are you sure you want to clear all entries?")) {
    localStorage.removeItem("stockHistory");
    loadHistory();
  }
}

// Calculate avg, profit/loss and fetch RSI
async function calculate() {
  const prices = document.querySelectorAll(".price");
  const qtys = document.querySelectorAll(".qty");
  let totalInvestment = 0, totalQty = 0;

  for (let i = 0; i < prices.length; i++) {
    const p = parseFloat(prices[i].value) || 0;
    const q = parseInt(qtys[i].value) || 0;
    totalInvestment += p * q;
    totalQty += q;
  }

  if (totalQty === 0) {
    document.getElementById("result").innerHTML = "<p>Please enter some values.</p>";
    return;
  }

  const avgPrice = totalInvestment / totalQty;
  const currentPrice = parseFloat(document.getElementById("currentPrice").value) || 0;
  const currentValue = currentPrice * totalQty;
  const profitLoss = currentValue - totalInvestment;

  document.getElementById("result").innerHTML = `
    <p><b>Average Buy Price:</b> ‚Çπ${avgPrice.toFixed(2)}</p>
    <p><b>Total Investment:</b> ‚Çπ${totalInvestment.toFixed(2)}</p>
    <p><b>Current Value:</b> ‚Çπ${currentValue.toFixed(2)}</p>
    <p><b>Profit/Loss:</b> <span style="color:${profitLoss>=0?'green':'red'}">‚Çπ${profitLoss.toFixed(2)}</span></p>`;

  const stock = document.getElementById("stockName").value.trim();
  let rsiValue = "N/A";
  if (stock) {
    try {
      const res = await fetch(`https://stock-avg.onrender.com/rsi?symbol=${stock}`);
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      const data = await res.json();
      if (data.error) {
        throw new Error(data.error);
      }
      rsiValue = data.rsi ? data.rsi.toFixed(2) : "N/A";
      document.getElementById("rsiResult").innerHTML = `<p><b>RSI (14):</b> ${rsiValue}</p>`;
    } catch (e) {
      console.error("RSI fetch error:", e);
      document.getElementById("rsiResult").innerHTML = `<p>‚ö†Ô∏è Unable to fetch RSI. ${e.message || 'Please check your internet connection and try again.'}</p>`;
    }
  }

  // Save entry
  const history = JSON.parse(localStorage.getItem("stockHistory") || "[]");
  history.push({
    stock,
    avgPrice: avgPrice.toFixed(2),
    totalInvestment: totalInvestment.toFixed(2),
    currentPrice: currentPrice.toFixed(2),
    profitLoss: profitLoss.toFixed(2),
    rsi: rsiValue
  });
  localStorage.setItem("stockHistory", JSON.stringify(history));
  loadHistory();
}

// Initialize
addBuy();
loadHistory();
</script>
</body>
</html>
